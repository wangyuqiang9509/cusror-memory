# 技术栈 Bug 模式知识库

> 此文档按需引用：在执行 `/init-project` 命令时自动读取

## 概述

本文档记录各技术栈的常见 Bug 模式、预防规则和最佳实践。用于项目初始化时智能预测潜在风险。

---

## 前端技术栈

### React

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| Hook 依赖缺失 | useEffect/useCallback 依赖数组不完整 | 启用 eslint-plugin-react-hooks |
| 无限重渲染 | 状态更新触发循环 | 避免在 render 中直接调用 setState |
| 闭包陷阱 | 事件处理器引用过期状态 | 使用 useRef 或函数式更新 |
| Key 警告忽略 | 列表渲染缺少唯一 key | 使用稳定的唯一标识符作为 key |
| 内存泄漏 | 组件卸载后仍执行异步操作 | useEffect 返回清理函数 |

**推荐规则：**
```markdown
### React Hook 规范

- ✅ 应该：始终在 useEffect 中返回清理函数
- ✅ 应该：使用 ESLint 插件检查 Hook 依赖
- ❌ 避免：在循环/条件语句中使用 Hook
- ❌ 避免：直接修改 state 对象
```

### Vue

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| 响应式丢失 | 解构 props/reactive 对象 | 使用 toRefs 保持响应式 |
| v-if/v-for 优先级 | 同时使用导致意外行为 | 分离到不同元素 |
| 异步组件加载失败 | 缺少错误处理 | 使用 defineAsyncComponent 的 errorComponent |
| 计算属性副作用 | computed 中执行异步操作 | computed 保持纯函数 |

**推荐规则：**
```markdown
### Vue 响应式规范

- ✅ 应该：使用 toRefs 解构响应式对象
- ✅ 应该：computed 保持纯函数，副作用用 watch
- ❌ 避免：v-if 和 v-for 同时用于同一元素
- ❌ 避免：直接修改 props
```

### TypeScript 通用

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| any 类型滥用 | 绕过类型检查 | 启用 noImplicitAny |
| 类型断言过度 | as 断言隐藏真实错误 | 优先使用类型守卫 |
| null/undefined 未处理 | 运行时空值错误 | 启用 strictNullChecks |
| 枚举值比较 | 数字枚举的隐式转换 | 使用字符串枚举 |

**推荐规则：**
```markdown
### TypeScript 类型安全

- ✅ 应该：启用 strict 模式
- ✅ 应该：使用类型守卫而非类型断言
- ❌ 避免：使用 any，改用 unknown
- ❌ 避免：非空断言 (!) 的过度使用
```

---

## 后端技术栈

### FastAPI (Python)

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| 同步阻塞 | 在 async 路由中调用同步阻塞代码 | 使用 run_in_executor 或 async 库 |
| Pydantic 验证失败 | 请求体不符合模型 | 提供清晰的错误信息 |
| 依赖注入循环 | Depends 循环依赖 | 模块化依赖设计 |
| 数据库会话泄漏 | 未正确关闭数据库连接 | 使用 yield 依赖或上下文管理器 |
| CORS 配置错误 | 跨域请求被拒绝 | 正确配置 CORSMiddleware |

**推荐规则：**
```markdown
### FastAPI 异步规范

- ✅ 应该：IO 操作使用 async/await
- ✅ 应该：数据库会话使用依赖注入 + yield
- ❌ 避免：在 async 函数中使用 time.sleep()
- ❌ 避免：在路由中直接创建数据库会话
```

### Django

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| N+1 查询 | 循环中触发额外查询 | 使用 select_related/prefetch_related |
| 迁移冲突 | 多分支产生冲突迁移 | 及时合并迁移文件 |
| 信号循环 | signal 触发导致无限循环 | 使用 dispatch_uid |
| 模板注入 | 用户输入未转义 | 使用 |safe 过滤器需谨慎 |

### Express/Node.js

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| 回调地狱 | 深层嵌套回调 | 使用 async/await |
| 未捕获异常 | Promise rejection 未处理 | 全局 unhandledRejection 处理 |
| 中间件顺序 | 错误处理中间件位置不对 | 错误中间件放最后 |
| 内存泄漏 | 事件监听器未移除 | 使用 once 或手动 removeListener |

**推荐规则：**
```markdown
### Node.js 错误处理

- ✅ 应该：使用 express-async-errors 或手动包装
- ✅ 应该：设置全局 unhandledRejection 处理器
- ❌ 避免：回调风格的异步代码
- ❌ 避免：同步阻塞主线程
```

---

## 数据库相关

### SQL/ORM 通用

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| SQL 注入 | 字符串拼接 SQL | 使用参数化查询 |
| N+1 问题 | 循环中查询关联数据 | 预加载关联 |
| 事务未提交 | 忘记 commit 或 rollback | 使用上下文管理器 |
| 死锁 | 事务锁顺序不一致 | 统一锁获取顺序 |
| 连接池耗尽 | 连接未归还 | 确保 finally 中释放连接 |

**推荐规则：**
```markdown
### 数据库操作规范

- ✅ 应该：始终使用参数化查询
- ✅ 应该：批量操作使用事务
- ❌ 避免：在循环中执行单条查询
- ❌ 避免：长事务持有锁
```

---

## 部署与配置

### Docker

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| 镜像过大 | 未使用多阶段构建 | 使用 multi-stage build |
| 权限问题 | root 用户运行容器 | 创建非特权用户 |
| 缓存失效 | COPY 顺序导致重复构建 | 依赖文件先复制 |
| 端口冲突 | 多容器端口映射冲突 | 使用 docker-compose 管理 |

### 环境配置

**常见 Bug 类型：**

| Bug 类型 | 描述 | 预防规则 |
|---------|------|---------|
| 密钥泄露 | .env 提交到代码库 | .gitignore 包含 .env |
| 环境差异 | 开发/生产环境不一致 | 使用相同的容器镜像 |
| 配置缺失 | 必需环境变量未设置 | 启动时验证必需变量 |

---

## 项目类型特定模式

### Web 应用

**关注领域：**
- 认证/授权
- XSS/CSRF 防护
- 性能优化（懒加载、缓存）
- 响应式设计

### CLI 工具

**关注领域：**
- 参数解析
- 错误提示友好性
- 进度显示
- 退出码规范

### 库/SDK

**关注领域：**
- API 向后兼容
- 文档完整性
- 类型定义导出
- 依赖最小化

### 微服务

**关注领域：**
- 服务发现
- 熔断降级
- 分布式追踪
- 数据一致性

---

## 从 Bug 中学到的规则

<!-- 此区域由 bug-to-rule 命令自动更新 -->

---
*文档版本：1.0.0*
*最后更新：项目初始化*
