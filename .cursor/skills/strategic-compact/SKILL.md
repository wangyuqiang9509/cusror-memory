---
name: strategic-compact
description: 在逻辑节点处建议手动压缩上下文，确保任务各阶段的关键信息得以保留，避免系统自动压缩带来的随机性问题。
---

# 策略性压缩技能

在工作流的关键节点主动建议执行 `/compact`，替代不可控的自动压缩机制。

## 为何需要策略性压缩？

自动压缩存在以下问题：
- 触发时机随机，常在任务进行中丢失重要上下文
- 无法感知任务的逻辑边界
- 可能中断复杂的多步骤操作流程

策略性压缩的优势（在逻辑边界处执行）：
- **探索完成后、执行开始前** - 压缩调研过程的上下文，保留实施方案
- **里程碑完成后** - 为下一阶段提供干净的起点
- **重大任务切换前** - 清理前序探索上下文，为新任务腾出空间

## 工作原理

`suggest-compact.sh` 脚本通过 PreToolUse（Edit/Write）钩子运行：

1. **追踪工具调用** - 统计会话中的工具调用次数
2. **阈值检测** - 达到可配置阈值时触发建议（默认：50 次调用）
3. **周期性提醒** - 超过阈值后每隔 25 次调用再次提醒

## 钩子配置

在 `~/.claude/settings.json` 中添加以下配置：

```json
{
  "hooks": {
    "PreToolUse": [{
      "matcher": "tool == \"Edit\" || tool == \"Write\"",
      "hooks": [{
        "type": "command",
        "command": "~/.claude/skills/strategic-compact/suggest-compact.sh"
      }]
    }]
  }
}
```

## 配置参数

环境变量：
- `COMPACT_THRESHOLD` - 首次建议前的工具调用次数阈值（默认：50）

## 最佳实践

1. **规划完成后压缩** - 方案敲定后压缩上下文，轻装上阵
2. **调试完成后压缩** - 清理错误排查过程的上下文，继续后续工作
3. **实现过程中避免压缩** - 保留关联变更所需的上下文
4. **审慎响应建议** - 钩子告诉你"何时可以压缩"，由你决定"是否执行"

## 相关资源

- [完整指南](https://x.com/affaanmustafa/status/2014040193557471352) - Token 优化章节
- 内存持久化钩子 - 用于保存压缩后仍需保留的状态
