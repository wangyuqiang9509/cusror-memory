---
description: 重述需求、评估风险，并制定分步实施计划。必须等待用户确认后方可动手编写任何代码。
---

# Plan 命令

本命令调用 **planner** 代理，在编写任何代码之前创建一份完整的实施计划。

## 命令功能

1. **重述需求** - 明确需要构建的内容
2. **识别风险** - 发现潜在问题和阻塞项
3. **制定分步计划** - 将实施拆分为多个阶段
4. **等待确认** - 必须获得用户批准后方可执行

## 适用场景

以下情况建议使用 `/plan`：
- 启动新功能开发
- 进行重大架构调整
- 执行复杂重构任务
- 涉及多个文件或组件的改动
- 需求模糊或存在歧义时

## 工作流程

planner 代理将执行以下操作：

1. **分析请求**，以清晰的语言重述需求
2. **分阶段拆解**，形成具体可执行的步骤
3. **识别依赖关系**，理清组件之间的关联
4. **评估风险**，标注潜在阻塞项
5. **估算复杂度**（高/中/低）
6. **呈现计划**，并等待你的明确确认

## 使用示例

```
用户: /plan 我需要在市场结算时添加实时通知功能

代理 (planner):
# 实施计划：市场结算实时通知

## 需求重述
- 当用户关注的市场结算时发送通知
- 支持多种通知渠道（站内通知、邮件、Webhook）
- 确保通知可靠送达
- 包含市场结果及用户持仓盈亏

## 实施阶段

### 阶段 1：数据库 Schema
- 新增 notifications 表，字段包括：id、user_id、market_id、type、status、created_at
- 新增 user_notification_preferences 表用于存储渠道偏好
- 在 user_id 和 market_id 上创建索引以优化性能

### 阶段 2：通知服务
- 在 lib/notifications.ts 中创建通知服务
- 基于 BullMQ/Redis 实现通知队列
- 添加失败重试逻辑
- 创建通知模板

### 阶段 3：集成入口
- 在市场结算逻辑中埋点（当 status 变为 "resolved" 时触发）
- 查询该市场下所有持仓用户
- 为每位用户入队通知任务

### 阶段 4：前端组件
- 在页头创建 NotificationBell 组件
- 添加 NotificationList 弹窗
- 基于 Supabase 订阅实现实时更新
- 新增通知偏好设置页

## 依赖项
- Redis（消息队列）
- 邮件服务（SendGrid/Resend）
- Supabase 实时订阅

## 风险评估
- 高：邮件送达率（需配置 SPF/DKIM）
- 中：单市场用户数超 1000 时的性能
- 中：市场频繁结算导致通知泛滥
- 低：实时订阅带来的额外开销

## 复杂度评估：中等
- 后端：4-6 小时
- 前端：3-4 小时
- 测试：2-3 小时
- 总计：9-13 小时

**等待确认**：是否按此计划执行？（是/否/修改）
```

## 重要说明

**关键提示**：planner 代理在你明确回复"是"、"执行"或类似肯定指令之前，**不会**编写任何代码。

如需调整计划，请回复：
- "修改：[你的修改意见]"
- "换个方案：[替代方案]"
- "跳过阶段 2，先执行阶段 3"

## 与其他命令的配合

规划完成后：
- 使用 `/tdd` 进行测试驱动开发
- 遇到构建错误时使用 `/build-and-fix`
- 使用 `/code-review` 审查已完成的实现

## 关联代理

本命令调用的 `planner` 代理位于：
`~/.claude/agents/planner.md`
